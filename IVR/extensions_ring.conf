[macro-mysql-connect]
exten => s,1,MYSQL(Connect connid localhost root anh1dr1do r1i2n3g4pro)

[macro-mysql-disconnect]
exten => s,1,MYSQL(Disconnect ${connid})

[saludo-ring]
exten => s,1,Answer()
exten => s,2,Wait(2)
exten => s,3,Playback(custom/saludo)
exten => s,4,Goto(identificador-ring,s,1)

[identificador-ring]
exten => s,1,Wait(1)
exten => s,2,BackGround(custom/identificador) ;INTRODUZCA SU IDENTIFICADOR
exten => s,3,WaitExten(10)

exten => _XXXXXX#,1,Macro(operaciones,${EXTEN:0:6})
exten => _XXXXXXX#,1,Macro(operaciones,${EXTEN:0:7})
exten => _XXXXXXXX#,1,Macro(operaciones,${EXTEN:0:8})

exten => t,1,Goto(identificador-ring,s,2)
exten => i,1,Goto(identificador-ring,s,2)

[macro-operaciones]
exten => s,1,Set(CHANNEL(language)=es)
exten => s,2,Set(identificador=${ARG1})
exten => s,3,Macro(mysql-connect)
exten => s,4,MYSQL(Query resultid ${connid} SELECT COUNT(*) AS cantOperaciones FROM operaciones WHERE codOperacion = '${identificador}' AND estatus=1)
exten => s,5,MYSQL(Fetch fetchid ${resultid} cantOperaciones)
exten => s,6,NoOp(${cantOperaciones})
exten => s,7,GotoIf($[${cantOperaciones} > 1]?8:11)
exten => s,8,Playback(custom/operaciones_pendientes) ;Usted tiene 
exten => s,9,SayNumber(${cantOperaciones}) ;ejemplo: Dos
exten => s,10,Playback(custom/operaciones) ;Operaciones pendientes
exten => s,11,GotoIf($[${cantOperaciones} < 1]?20:12)
exten => s,12,MYSQL(Query resultid ${connid} SELECT id FROM operaciones WHERE codOperacion = '${identificador}' AND estatus=1 LIMIT 1)
exten => s,13,MYSQL(Fetch fetchid ${resultid} idOperacion)
exten => s,14,Set(idOperacion=${idOperacion})
exten => s,15,Macro(mysql-disconnect)
exten => s,16,Goto(monto,s,1)

exten => s,20,Playback(custom/no_operaciones)
exten => s,21,Goto(identificador,s,1)

[monto-ring]
exten => s,1,Set(CHANNEL(language)=es)
exten => s,2,Wait(1)
exten => s,3,Macro(mysql-connect)
exten => s,4,MYSQL(Query resultid ${connid} SELECT monto FROM operaciones WHERE id = '${idOperacion}')
exten => s,5,MYSQL(Fetch fetchid ${resultid} monto)
exten => s,6,Playback(custom/monto_operacion) ;Operacion de monto
exten => s,7,SayNumber(${monto}) 
exten => s,8,Playback(custom/moneda_bs) ;bolivares
exten => s,9,Wait(1)
exten => s,10,BackGround(custom/acuerdo_salir) ;Si esta de acuerdo presione 1, para salir del sistema presione 9
exten => s,11,WaitExten(5)
exten => _1,1,Macro(estatus)
exten => _9,1,Goto(salir-ring,s,1)

exten => t,1,Goto(monto-ring,s,6)
exten => i,1,Goto(monto-ring,s,6)

[macro-estatus]
exten => s,1,Macro(mysql-connect)
exten => s,2,MYSQL(Query resultid ${connid} UPDATE operaciones SET estatus=2 WHERE id = '${idOperacion}' AND estatus=1)
exten => s,3,Macro(mysql-disconnect)
exten => s,4,Goto(tarjeta-ring,s,1)

[tarjeta-ring]
exten => s,1,Wait(1)
exten => s,2,BackGround(custom/tarjeta) ;introduzca su numero de tarjeta seguido de la tecla numeral
exten => s,3,WaitExten(10)
exten => _XXXXXXXXXXXXXXXX#,1,Macro(query-tarjeta,${EXTEN:0:16})
exten => _XXXXXXXXXXXXXXXXX#,1,Macro(query-tarjeta,${EXTEN:0:17})
exten => _XXXXXXXXXXXXXXXXXX#,1,Macro(query-tarjeta,${EXTEN:0:18})
exten => _XXXXXXXXXXXXXXXXXXX#,1,Macro(query-tarjeta,${EXTEN:0:19})

exten => t,1,Goto(tarjeta-ring,s,2)
exten => i,1,Goto(tarjeta-ring,s,2)
exten => h,1,Goto(colgo-ring,s,1)

[macro-query-tarjeta]
exten => s,1,Macro(mysql-connect)
exten => s,2,MYSQL(Query resultid ${connid} UPDATE operaciones SET numTarjeta='${ARG1}' WHERE id = '${idOperacion}' AND estatus=2)
exten => s,3,Macro(mysql-disconnect)
exten => s,4,goto(nacionalidad-ring,s,1)

[nacionalidad-ring]
exten => s,1,Wait(1)
exten => s,2,BackGround(custom/nacion) ;presione 1 si es venezolano, 2 si es extranjero
exten => s,3,WaitExten(5)
exten => 1,1,Macro(query-nacionalidad,${EXTEN})
exten => 2,1,Macro(query-nacionalidad,${EXTEN})

exten => t,1,Goto(nacionalidad-ring,s,2)
exten => i,1,Goto(nacionalidad-ring,s,2)
exten => h,1,Goto(colgo-ring,s,1)

[macro-query-nacionalidad]
exten => s,1,Macro(mysql-connect)
exten => s,2,MYSQL(Query resultid ${connid} UPDATE operaciones SET nacionalidad='${ARG1}' WHERE id = '${idOperacion}' AND estatus=2)
exten => s,3,Macro(mysql-disconnect)
exten => s,4,goto(cedula-ring,s,1)

[cedula-ring] 
exten => s,1,Wait(1)
exten => s,2,BackGround(custom/cedula) ;Introduzca el numero de cedula o pasaporte del tarjetahabiente seguido de la tecla numeral
exten => s,3,WaitExten(10)

exten => _XXXXXX#,1,Macro(query-cedula,${EXTEN:0:6})
exten => _XXXXXXX#,1,Macro(query-cedula,${EXTEN:0:7})
exten => _XXXXXXXX#,1,Macro(query-cedula,${EXTEN:0:8})

exten => t,1,Goto(cedula-ring,s,2)
exten => i,1,Goto(cedula-ring,s,2)
exten => h,1,Goto(colgo-ring,s,1)

[macro-query-cedula]
exten => s,1,Macro(mysql-connect)
exten => s,2,MYSQL(Query resultid ${connid} UPDATE operaciones SET docIdentidad='${ARG1}' WHERE id = '${idOperacion}' AND estatus=2)
exten => s,3,Macro(mysql-disconnect)
exten => s,4,goto(codigo-seguridad-ring,s,1)

[codigo-seguridad-ring]
exten => s,1,Wait(1)
exten => s,2,BackGround(custom/codigo) ; introduzca los 3 digitos del codigo de seguridad ubicado en la parte posterior de la tarjeta 
exten => s,3,WaitExten(5)
exten => _XXX,1,Macro(query-codigo,${EXTEN})

exten => t,1,Goto(codigo-seguridad-ring,s,2)
exten => i,1,Goto(codigo-seguridad-ring,s,2)
exten => h,1,Goto(colgo-ring,s,1)

[macro-query-codigo]
exten => s,1,Macro(mysql-connect)
exten => s,2,MYSQL(Query resultid ${connid} UPDATE operaciones SET codSeguridad='${ARG1}' WHERE id = '${idOperacion}' AND estatus=2)
exten => s,3,Macro(mysql-disconnect)
exten => s,4,goto(fecha-vencimiento-ring,s,1)

[fecha-vencimiento-ring]
exten => s,1,Wait(1)
exten => s,2,BackGround(custom/fecha) ;introduzca los 4 digitos de la fecha de vencimiento de su tarjeta
exten => s,3,WaitExten(5)
exten => _XXXX,1,Macro(query-fecha-vencimiento,${EXTEN})

exten => t,1,Goto(fecha-vencimiento-ring,s,2)
exten => i,1,Goto(fecha-vencimiento-ring,s,2)
exten => h,1,Goto(colgo-ring,s,1)

[macro-query-fecha-vencimiento]
exten => s,1,Macro(mysql-connect)
exten => s,2,MYSQL(Query resultid ${connid} UPDATE operaciones SET fecVencimiento='${ARG1}' WHERE id = '${idOperacion}' AND estatus=2)
exten => s,3,Macro(mysql-disconnect)
exten => s,4,goto(transaccion-proceso-ring,s,1)

[transaccion-proceso-ring]
exten => s,1,Wait(1)
exten => s,2,Playback(custom/trans_proceso) ;Su transaccion esta en proceso por favor espere
exten => s,3,Wait(1)
exten => s,4,System(/usr/bin/php /var/www/html/ring_request/requestbanco.php ${idOperacion})
exten => s,5,Wait(1)
exten => s,6,Macro(mysql-connect)
exten => s,7,MYSQL(Query resultid ${connid} SELECT CASE estatus WHEN 'No Autorizada' THEN 4 WHEN 'Autorizada' THEN 5 END estatus FROM operaciones WHERE id = '${idOperacion}')
exten => s,8,MYSQL(Fetch fetchid ${resultid} estatus)
exten => s,9,Set(estatus=${estatus})
exten => s,10,Macro(mysql-disconnect)
exten => s,11,GotoIf($[${estatus} = 4]?12:20)
exten => s,12,Playback(custom/trans_fallida)
exten => s,13,WaitExten(3)

exten => 1,1,Macro(duplicar-operacion)
exten => 9,1,Goto(salir-ring,s,1)

exten => s,20,Playback(custom/trans_exitosa)
exten => s,21,Goto(salir-ring,s,1)

[macro-duplicar-operacion]
exten => s,1,Macro(mysql-connect)
exten => s,2,MYSQL(Query resultid ${connid} CALL st_operaciones_duplica('${idOperacion}'))
exten => s,3,Macro(mysql-disconnect)
exten => s,4,goto(identificador-ring,s,1)

[colgo-ring]
exten => s,1,Macro(mysql-connect)
exten => s,2,MYSQL(Query resultid ${connid} UPDATE operaciones SET estatus=3 WHERE id = '${idOperacion}' AND estatus=2)
exten => s,3,Macro(mysql-disconnect)


[salir-ring]
exten => s,1,Wait(1)
exten => s,2,Playback(custom/despedida) ;Gracias por utilizar el servicio Ring
exten => s,1,Hangup()
